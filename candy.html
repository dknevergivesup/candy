<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="main.css" />
    <title>Document</title>
  </head>
  <body>
    <div class="container">
      <table>
        <tr>
          <td>
            <input type="button" id="button-0-0" data-row="0" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-0-1" data-row="0" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-0-2" data-row="0" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-0-3" data-row="0" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-0-4" data-row="0" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-1-0" data-row="1" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-1-1" data-row="1" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-1-2" data-row="1" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-1-3" data-row="1" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-1-4" data-row="1" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-2-0" data-row="2" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-2-1" data-row="2" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-2-2" data-row="2" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-2-3" data-row="2" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-2-4" data-row="2" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-3-0" data-row="3" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-3-1" data-row="3" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-3-2" data-row="3" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-3-3" data-row="3" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-3-4" data-row="3" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-4-0" data-row="4" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-4-1" data-row="4" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-4-2" data-row="4" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-4-3" data-row="4" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-4-4" data-row="4" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-5-0" data-row="5" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-5-1" data-row="5" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-5-2" data-row="5" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-5-3" data-row="5" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-5-4" data-row="5" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-6-0" data-row="6" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-6-1" data-row="6" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-6-2" data-row="6" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-6-3" data-row="6" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-6-4" data-row="6" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-7-0" data-row="7" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-7-1" data-row="7" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-7-2" data-row="7" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-7-3" data-row="7" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-7-4" data-row="7" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-8-0" data-row="8" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-8-1" data-row="8" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-8-2" data-row="8" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-8-3" data-row="8" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-8-4" data-row="8" data-col="4" />
          </td>
        </tr>
        <tr>
          <td>
            <input type="button" id="button-9-0" data-row="9" data-col="0" />
          </td>
          <td>
            <input type="button" id="button-9-1" data-row="9" data-col="1" />
          </td>
          <td>
            <input type="button" id="button-9-2" data-row="9" data-col="2" />
          </td>
          <td>
            <input type="button" id="button-9-3" data-row="9" data-col="3" />
          </td>
          <td>
            <input type="button" id="button-9-4" data-row="9" data-col="4" />
          </td>
        </tr>
      </table>
    </div>
  </body>
  <script>
    //DONG KI, SIN & Harry
    const board = [];
    const suits = {
      1: "üç¨",
      2: "üç≠",
      3: "üç©",
      4: "üç´",
      5: "üçí",
      6: "üçâ",
      0: "üí£",
    };

    for (let i = 0; i < 10; i++) {
      const row = [];
      for (let j = 0; j < 5; j++) {
        const randomSuitIndex = Math.floor(Math.random() * 6) + 1;
        row.push(suits[randomSuitIndex]);
      }
      board.push(row);
    }
    function show() {
      for (let i = 0; i < 10; i++) {
        for (let j = 0; j < 5; j++) {
          const buttonId = `button-${i}-${j}`;
          const myButton = document.getElementById(buttonId);
          myButton.value = board[i][j];
        }
      }
    }

    let selectedButton = null;

    function swapValues(selectedRow, selectedCol, clickedRow, clickedCol) {
      const temp = board[selectedRow][selectedCol];
      board[selectedRow][selectedCol] = board[clickedRow][clickedCol];
      board[clickedRow][clickedCol] = temp;
    }

    function areAdjacent(row1, col1, row2, col2) {
      return Math.abs(row1 - row2) + Math.abs(col1 - col2) === 1;
    }

    async function handleClick(button) {
      clearTimeout(timer)
      if (selectedButton === null) {
        selectedButton = button;
        button.style.backgroundColor = "lightblue";
      } else {
        const selectedRow = parseInt(selectedButton.getAttribute("data-row"));
        const selectedCol = parseInt(selectedButton.getAttribute("data-col"));
        const clickedRow = parseInt(button.getAttribute("data-row"));
        const clickedCol = parseInt(button.getAttribute("data-col"));
        selectedButton.style.backgroundColor = "";
        selectedButton = null;
        if (areAdjacent(selectedRow, selectedCol, clickedRow, clickedCol)) {
          swapValues(selectedRow, selectedCol, clickedRow, clickedCol);
          const crush_set = new Set();
          let first = expand(selectedRow, selectedCol);
          let second = expand(clickedRow, clickedCol);
          if (first.size === 0 && second.size === 0) {
            swapValues(selectedRow, selectedCol, clickedRow, clickedCol);
            selectedButton.style.backgroundColor = "";
            selectedButton = null;
            return;
          }
          show();
          await sleep(1000);
          if (first) {
            first.forEach((item) => {
              crush_set.add(item);
            });
          }
          if (second) {
            second.forEach((item) => {
              crush_set.add(item);
            });
          }
          red(crush_set);
          await sleep(1000);
          crush(crush_set);
          show();
          await sleep(1000);
          unred(crush_set);
          drop();
          await replace();
          show();
          await sleep(1000);
          let re_crush = re_expand();
          while (re_crush.size > 0) {
            red(re_crush);
            await sleep(1000);
            crush(re_crush);
            show();
            await sleep(1000);
            unred(re_crush);
            await drop();
            await replace();
            show();
            await sleep(1000);
            re_crush = re_expand();
          }
          let hint = check_gameover();
          if(hint.size === 0){
            alert("Game Over");
          }
          await startTimer(hint);
        }
      }
    }

    async function hint_delay(hint) {
      let hint_array = give_hint(hint);
      hint_red(hint_array);
      await sleep(3000);
      hint_unred(hint_array);
    }



    let timer;
    async function startTimer(hint) {
      timer = setTimeout(function () {
        ;
        hint_delay(hint)}, 10000); 
    }

    function cancelTimer() {
      clearTimeout(timer);
    }

    function give_hint(hint){
      const hint_array = Array.from(hint);
      const randomSuitIndex = Math.floor(Math.random() * hint_array.length);
      console.log(randomSuitIndex);
      console.log(hint_array[randomSuitIndex]);
      return hint_array[randomSuitIndex];

    }

    function hint_red(hint_array){
      hint_array.forEach((coordinate) => {
        const [row, col] = coordinate.split("-").map(Number);
        const buttonId = `button-${row}-${col}`;
        const myButton = document.getElementById(buttonId);
        myButton.style.backgroundColor = "red";
      });
    }

    function hint_unred(hint_array){
      hint_array.forEach((coordinate) => {
        const [row, col] = coordinate.split("-").map(Number);
        const buttonId = `button-${row}-${col}`;
        const myButton = document.getElementById(buttonId);
        myButton.style.backgroundColor = "";
      });
    }

    const buttons = document.querySelectorAll("input[type='button']");
    buttons.forEach((button) => {
      button.addEventListener("click", () => handleClick(button));
    });

    function expand(r, c) {
      let left = c;
      let right = c;
      let up = r;
      let down = r;
      const upDown = new Set();
      const leftRight = new Set();
      const crush = new Set();
      let upDownFlag = false;
      let leftRightFlag = false;
      upDown.add(`${up}-${c}`);
      leftRight.add(`${r}-${right}`);

      while (up + 1 < board.length && board[up][c] === board[up + 1][c]) {
        upDown.add(`${up + 1}-${c}`);
        up++;
      }
      while (down - 1 >= 0 && board[down][c] === board[down - 1][c]) {
        upDown.add(`${down - 1}-${c}`);
        down--;
      }
      while (
        right + 1 < board[0].length &&
        board[r][right] === board[r][right + 1]
      ) {
        leftRight.add(`${r}-${right + 1}`);
        right++;
      }
      while (left - 1 >= 0 && board[r][left] === board[r][left - 1]) {
        leftRight.add(`${r}-${left - 1}`);
        left--;
      }

      if (upDown.size >= 3) {
        upDownFlag = true;
      }
      if (leftRight.size >= 3) {
        leftRightFlag = true;
      }

      if (upDownFlag) {
        upDown.forEach((item) => {
          crush.add(item);
        });
      }
      if (leftRightFlag) {
        leftRight.forEach((item) => {
          crush.add(item);
        });
      }
      return crush;
    }

    function re_expand() {
      const crushSet = new Set();
      for (let r = 0; r < board.length; r++) {
        for (let c = 0; c < board[0].length; c++) {
          const upDown = new Set();
          const leftRight = new Set();
          let left = c;
          let right = c;
          let up = r;
          let down = r;
          let upDownFlag = false;
          let leftRightFlag = false;
          upDown.add(`${up}-${c}`);
          leftRight.add(`${r}-${right}`);

          while (up + 1 < board.length && board[up][c] === board[up + 1][c]) {
            upDown.add(`${up + 1}-${c}`);
            up++;
          }
          while (down - 1 >= 0 && board[down][c] === board[down - 1][c]) {
            upDown.add(`${down - 1}-${c}`);
            down--;
          }
          while (
            right + 1 < board[0].length &&
            board[r][right] === board[r][right + 1]
          ) {
            leftRight.add(`${r}-${right + 1}`);
            right++;
          }
          while (left - 1 >= 0 && board[r][left] === board[r][left - 1]) {
            leftRight.add(`${r}-${left - 1}`);
            left--;
          }

          if (upDown.size >= 3) {
            upDownFlag = true;
          }
          if (leftRight.size >= 3) {
            leftRightFlag = true;
          }

          if (upDownFlag) {
            upDown.forEach((item) => {
              crushSet.add(item);
            });
          }
          if (leftRightFlag) {
            leftRight.forEach((item) => {
              crushSet.add(item);
            });
          }
        }
      }
      return crushSet;
    }

    function find() {
      const crushSet = new Set();
      for (let r = 0; r < board.length; r++) {
        for (let c = 0; c < board[0].length; c++) {
          if (
            r >= 1 &&
            r < board.length - 1 &&
            board[r - 1][c] === board[r][c] &&
            board[r][c] === board[r + 1][c]
          ) {
            crushSet.add(`${r - 1}-${c}`);
            crushSet.add(`${r}-${c}`);
            crushSet.add(`${r + 1}-${c}`);
          }
          if (
            c >= 1 &&
            c < board[0].length - 1 &&
            board[r][c - 1] === board[r][c] &&
            board[r][c] === board[r][c + 1]
          ) {
            crushSet.add(`${r}-${c - 1}`);
            crushSet.add(`${r}-${c}`);
            crushSet.add(`${r}-${c + 1}`);
          }
        }
      }

      return crushSet;
    }
    function red(crushSet) {
      crushSet.forEach((coordinate) => {
        const [r, c] = coordinate.split("-").map(Number);
        const buttonId = `button-${r}-${c}`;
        const myButton = document.getElementById(buttonId);
        myButton.style.backgroundColor = "red";
      });
    }

    function unred(crushSet) {
      crushSet.forEach((coordinate) => {
        const [r, c] = coordinate.split("-").map(Number);
        const buttonId = `button-${r}-${c}`;
        const myButton = document.getElementById(buttonId);
        myButton.style.backgroundColor = "";
      });
    }

    function crush(crushSet) {
      crushSet.forEach((coordinate) => {
        const [r, c] = coordinate.split("-").map(Number);
        board[r][c] = suits[0];
      });
    }

    function drop() {
      for (let c = 0; c < board[0].length; c++) {
        let rLevel = board.length - 1;
        for (let r = board.length - 1; r >= 0; r--) {
          if (board[r][c] !== suits[0]) {
            board[rLevel][c] = board[r][c];
            if (r !== rLevel) {
              board[r][c] = suits[0];
            }
            rLevel--;
          }
        }
      }
    }

    function replace() {
      for (let r = 0; r < board.length; r++) {
        for (let c = 0; c < board[0].length; c++) {
          if (board[r][c] === suits[0]) {
            const randomSuitIndex = Math.floor(Math.random() * 6) + 1;
            board[r][c] = suits[randomSuitIndex];
          }
        }
      }
    }

    function remove() {
      let crushSet = find();
      while (crushSet.size > 0) {
        crush(crushSet);
        drop();
        replace();
        crushSet = find();
        show();
      }
    }

    function check_gameover() {
      const pairs = new Set();
      for (let r = 0; r < board.length; r++) {
        for (let c = 0; c < board[0].length; c++) {
          if (c >= 2 && c < board[0].length - 1) {
            if (board[r][c - 2] === board[r][c] && board[r][c] === board[r][c + 1]) {
              pairs.add([`${r}-${c - 2}`, `${r}-${c}`, `${r}-${c + 1}`]);
            }
          }
          if (c < board[0].length - 3) {
            if (board[r][c] === board[r][c + 1] && board[r][c + 1] === board[r][c + 3]) {
              pairs.add([`${r}-${c}`, `${r}-${c + 1}`, `${r}-${c + 3}`]);
            }
          }
          if (r >= 2 && r < board.length - 1) {
            if (board[r - 2][c] === board[r][c] && board[r][c] === board[r + 1][c]) {
              pairs.add([`${r - 2}-${c}`, `${r}-${c}`, `${r + 1}-${c}`]);
            }
          }
          if (r < board.length - 3) {
            if (board[r][c] === board[r + 1][c] && board[r + 1][c] === board[r + 3][c]) {
              pairs.add([`${r}-${c}`, `${r + 1}-${c}`, `${r + 3}-${c}`]);
            }
          }
          if (r >= 1 && c < board[0].length - 1 && c >= 1) {
            if (board[r][c] === board[r - 1][c - 1] && board[r - 1][c - 1] === board[r - 1][c + 1]) {
              pairs.add([
                `${r}-${c}`,
                `${r - 1}-${c - 1}`,
                `${r - 1}-${c + 1}`,
              ]);
            }
          }
          if (r >= 1 && c < board[0].length - 1 && r < board.length - 1) {
            if (board[r][c] === board[r - 1][c + 1] && board[r - 1][c + 1] === board[r + 1][c + 1]) {
              pairs.add([
                `${r}-${c}`,
                `${r - 1}-${c + 1}`,
                `${r + 1}-${c + 1}`,
              ]);
            }
          }
          if (c < board[0].length - 1 && r < board.length - 1 && c >= 1) {
            if (board[r][c] === board[r + 1][c + 1] && board[r + 1][c + 1] === board[r + 1][c - 1]) {
              pairs.add([
                `${r}-${c}`,
                `${r + 1}-${c + 1}`,
                `${r + 1}-${c - 1}`,
              ]);
            }
          }
          if (c >= 1 && r >= 1 && r < board.length - 1) {
            if (board[r][c] === board[r + 1][c - 1] && board[r + 1][c - 1] === board[r - 1][c - 1]) {
              pairs.add([
                `${r}-${c}`,
                `${r + 1}-${c - 1}`,
                `${r - 1}-${c - 1}`,
              ]);
            }
          }

          if (r < board.length - 1 && c < board[0].length - 2) {
            if (board[r][c] === board[r][c + 1] && board[r][c + 1] === board[r + 1][c + 2]) {
              pairs.add([`${r}-${c}`, `${r}-${c + 1}`, `${r + 1}-${c + 2}`]);
            }
          }
          if (r >= 1 && c < board[0].length - 2) {
            if (board[r][c] === board[r][c + 1] && board[r][c + 1] === board[r - 1][c + 2]) {
              pairs.add([`${r}-${c}`, `${r}-${c + 1}`, `${r - 1}-${c + 2}`]);
            }
          }
          if (r < board.length - 1 && c >= 1 && c < board[0].length - 1) {
            if (board[r + 1][c - 1] === board[r][c] && board[r][c] === board[r][c + 1]) {
              pairs.add([`${r + 1}-${c - 1}`, `${r}-${c}`, `${r}-${c + 1}`]);
            }
          }
          if (r >= 1 && c >= 1 && c < board[0].length - 1) {
            if (board[r - 1][c - 1] === board[r][c] && board[r][c] === board[r][c + 1]) {
              pairs.add([`${r - 1}-${c - 1}`, `${r}-${c}`, `${r}-${c + 1}`]);
            }
          }
          if (c < board[0].length - 1 && r < board.length - 2) {
            if (board[r][c] === board[r + 1][c] && board[r + 1][c] === board[r + 2][c + 1]) {
              pairs.add([`${r}-${c}`, `${r + 1}-${c}`, `${r + 2}-${c + 1}`]);
            }
          }
          if (c >= 1 && r < board.length - 2) {
            if (board[r][c] === board[r + 1][c] && board[r + 1][c] === board[r + 2][c - 1]) {
              pairs.add([`${r}-${c}`, `${r + 1}-${c}`, `${r + 2}-${c - 1}`]);
            }
          }
          if (r >= 1 && c >= 1 && r < board.length - 1) {
            if (board[r - 1][c - 1] === board[r][c] && board[r][c] === board[r + 1][c]) {
              pairs.add([`${r - 1}-${c - 1}`, `${r}-${c}`, `${r + 1}-${c}`]);
            }
          }
          if (r >= 1 && c < board[0].length - 1 && r < board.length - 1) {
            if (board[r - 1][c + 1] === board[r][c] && board[r][c] === board[r + 1][c]) {
              pairs.add([`${r - 1}-${c + 1}`, `${r}-${c}`, `${r + 1}-${c}`]);
            }
          }
        }
      }
      return pairs;
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }
    remove();
    show();
  </script>
</html>
